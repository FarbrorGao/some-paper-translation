# DS-SLAM:动态环境下的语义视觉SLAM
## 摘要
同时定位与建图（SLAM）被认为是智能移动机器人最基本的能力。在过去的几十年里，很多SLAM系统以其在特定条件下出色的性能给人们留下了深刻的印象。然而，依然存在着很多亟待解决的问题，比如说如何处理动态环境中的移动物体，如何使机器人真正的理解周围环境并完成更高级的任务。   
  
在本篇论文中，作者提出了一个鲁棒的针对动态环境的语义视觉SLAM系统叫做DS-SLAM。该系统中共有5个并行的线程：跟踪，语义分割，局部建图，闭环，以及语义地图的稠密重建。  
  
DS-SLAM结合了语义分割网络与移动一致性检测方法来减少动态动态物体的影响，由此极大的提高了动态环境中定位的精度。与此同时，该系统生成了一个可以被用于高阶任务的稠密语义八叉树地图。   
  
作者在TUM RGB-D数据集以及真实环境下测试了该系统，结果表明该熊的绝对路径比ORB-SLAM2提高了一个数量级。所以DS-SLAM是高动态环境中目前最先进的SLAM系统。  
# I.INTRODUCION(介绍)
近年来，视觉SLAM得到了广泛的研究，因为图像存储了丰富的信息，可以用于其他基于视觉的应用，如语义分割和目标检测。现代视觉SLAM系统框架已经相当成熟，通常由特征提取器前端、状态估计器后端、闭环检测器等几个关键部分组成。此外，一些先进的SLAM算法已经取得了令人满意的性能，如ORB-SLAM2[1], LSD-SLAM[2]。  
  
然而，一些问题仍然没有得到解决，例如，现有的算法大多是脆弱的。一方面。他们很难处理各种各样的环境，比如(非常)动态或粗糙的环境。另一方面，他们的地图模型往往是基于几何信息，比如基于路标的地图和点云地图一样，它们不能提供对周围环境的任何高级理解。根据文献[3]，SLAM进入机器人感知时代，需要更多的研究来为自主机器人实现真正健壮的感知和导航。    
  
典型的SLAM方法只提供带有几何实体(点、面等)的地图，它们之间没有语义属性的区别。然而，机器人需要语义信息来理解周围的场景。随着深度学习的发展，一些网络在语义分割方面取得了良好的性能。因此，将这些网络与SLAM相结合可以生成语义图，从而提高机器人的感知水平[5,6]。    
  
SLAM系统在动态环境中的鲁棒性也是一个挑战。现代SLAM系统大多是在特定的环境下成功论证的，而环境的意外变化很可能会破坏状态估计的质量，甚至导致系统失效。例如，在基于视觉的SLAM系统中，环境中动态的存在，比如行走的人，可能会欺骗特征关联。虽然一些基于激光的SLAM在环境变化的影响方面取得了一定的进展。例如，一些方法将惯性测量单元与视觉SLAM相结合以提高鲁棒性，如[7]，但在纯视觉SLAM中，该问题仍未得到很好的解决。  
   
本文将语义分割网络与光流方法相结合，重点研究在基于视觉的SLAM中减少动态对象的影响，同时给出八叉树映射[8]的语义表示，该映射可用于机器人的高级任务。DS-SLAM概述如图1所示:<center>![Snipaste_2019-04-10_14-08-36.png](https://i.loli.net/2019/04/10/5cad887349109.png)</center>
<center>图1.DS-SLAM概述。利用原始RGB图像同时进行语义分割和运动一致性检验。然后去除异常值并估计姿态。语义八叉树映射是建立在一个独立的线程基于姿态，深度图像，和语义分割结果。</center>
本文的主要贡献包括:   
1. 提出了一种基于ORB-SLAM2的动态环境下完整的语义SLAM系统(DS-SLAM)[2]。从而减小了动态目标对姿态估计的影响。利用TUM RGB-D 数据集[9]对系统的有效性进行了评价。结果表明，DS-SLAM在动态环境下的精度和鲁棒性显著优于ORB-SLAM2。该系统还集成了机器人操作系统(ROS)[10]，并在实际环境中对机器人进行了DS-SLAM测试，验证了该系统的性能。  
2. 我们将实时语义分割网络放在一个独立的线程中，将语义分割与移动一致性检查方法相结合，滤除场景中的动态部分，如行人。从而提高了定位模块和建图模块在动态场景中的鲁棒性和准确性。  
3. DS-SLAM创建一个单独的线程来构建一个密集的语义三维八叉树映射[8]。密集语义三维八叉树图采用log-odds score 方法滤除 不稳定 体素，并更新这些体素的语义。   

本文其余部分的结构如下。II部分概述了目前在动态环境中的语义SLAM和SLAM方面的各种成就。然后，第三节介绍了该方法的框架。详细介绍了整个SLAM系统，即如何检测动态对象并生成语义映射。随后。第四部分提供了DS-SLAM在TUM RGB-D数据集[91]和真实环境下性能的定性和定量结果，以证明系统的有效性和准确性。最后，第五部分给出了简要的结论和讨论。<center>[![1554818105(1).png](https://i.loli.net/2019/04/10/5cad7c4be5bde.png)](https://i.loli.net/2019/04/10/5cad7c4be5bde.png)</center>

<center>图2.DS-SLAM框架。局部建图线程和闭环线程与ORB-SLAM2相同。前者处理新的关键帧，进行局部束调整，在摄像机位姿的环境中实现最优重建;后者搜索循环，在检测到循环时进行图优化。</center>

## II相关工作
A. 语义SLAM
由于单纯基于几何的地图无法提供对周围环境的概念知识来方便复杂的任务，将语义概念与环境中的几何实体联系起来成为近年来的一个热门研究领域。在以往的许多作品中，语义图往往由几何部分和语义部分组成。之后，一组方法对目标识别子系统进行预先训练，并将semantio信息附加到识别的对象模型上。Vasudevan等人的[11]应用一个简单的朴素贝叶斯分类器来识别场景类别，并给出了一个基于预训练对象的空间分层概率表示。最近，Sengupta等人提出了一种有效的三维模型描述方法，该方法将八叉树嵌入到一个分层的鲁棒马尔可夫随机域中，为图中的每个体素提供语义标签。随着深度学习的出现，语义分割的效果得到了很大的提高。Sunderhauf等人[13]将卷积神经网络应用于基于最近邻方法的三维点分割和与对象相关的射标，然后添加或更新目标对象点云信息和隶属类型置信值的映射。  
然而，他们的工作只关注语义映射和对象识别，而其他部分对语义信息的使用并不充分。Bao等人[14]首先尝试利用场景中的几何属性和语义属性来联合估计相机的姿态、点和物体，显著提高了目标识别的准确性。**本文不仅利用语义信息生成基于八叉树的环境表示，而且在动态环境跟踪过程中利用语义信息过滤异常值。为了准确地进行语义分割，我们使用语义分割网络来跟踪最先进的工作路线。**

## III.系统介绍
本节将详细介绍DS-SLAM。本节包括五个方面。首先，给出了DS-SLAM体系结构框图。其次，简要介绍了DS-SLAM中采用的实时语义分割方法。然后介绍了用于检测特征点运动一致性的方法。随后，在此基础上，提出了一种结合语义分割和运动一致性检验的异常值剔除方法。最后,我们提出的方法构建语义八叉树地图。

### A.DS-SLAM框架  

在实际应用中，精确的姿态估计和恶劣环境下的可靠性是评价自主机器人的关键因素。ORB-SLAM2在大多数实际情况下都具有出色的性能。因此，在DS-SLAM中采用了ORB-SLAM2来提供一个全局的基于特征的SLAM解决方案，使我们能够检测动态对象并生成语义八叉树映射。DS-SLAM概述如图1所示。    
在DS-SLAM中，五个线程并行运行:跟踪、语义分割、局部映射、循环关闭和密集映射创建。系统框架如图2所示。对Kinect2采集的原始RGB图像同时进行跟踪线程和语义分割线程处理。跟踪线程首先提取ORB特征点，然后粗略地检查特征点的运动一致性，并保存潜在的异常值。然后跟踪线程等待语义分割线程预测的具有像素级语义标签的图像。分割结果到达后，基于分割结果和之前检测到的潜在异常点，丢弃运动目标中定位的ORB特征点异常点。然后。通过匹配剩余的稳定特征点计算变换矩阵。
### B.语义分割 
该系统是为实际应用而设计的，因此应该在实时性和准确性之间取得平衡。DS-SLAM采用SegNet[4]，实时提供基于caffe[171]的像素级语义分割。在PASCAL VOC数据集[18] 上训练的SegNet可以分割20个类。在实际应用中，人最有可能是动态对象，所以我们假设位于人中的特征点最有可能是异常值。  
### C.运动一致性检测
由于运动分割耗时较长，并且可以从另一个线程获得语义分割结果，所以我们只需要确定分割结果中的关键点是否在移动。如果在一个分段对象中确定一些点是动态的，那么该对象就可以看作是一个动态对象。本文提出的运动点检测思想简单明了。第一步是计算光流金字塔，得到当前帧中匹配的特征点。如果匹配对太靠近图像边缘，或者匹配对中心的3 X3图像块像素差太大，将会丢弃匹配对。第三步是使用inliers最多的RANSAC来寻找基本矩阵。然后利用基本矩阵计算当前帧中的极线。最后，确定匹配点到对应极线的距离是否小于某一阈值。如果距离大于阈值，则确定匹配点在移动。  
基本矩阵将最后一帧的特征点映射到当前帧中相应的搜索域，即。纵向线。设`$p_1$`、`$p_2$`分别表示上一帧和当前帧中的匹配点，`$p_1$`、`$p_2$`为它们的齐次坐标形式:    <center>`$P_1=[u_1,v_1,1],P_2=[u_2,v_2,1],$`</center><center>`$p_1=[u_1,v_1],p_2=[u_2,v_2],$`</center>
其中u, v为图像帧中的值。那么表示为`$I_1$`的极线可以由下式计算:<center>`$I_1=\left[
\begin{matrix}
X\\
Y\\
Z
\end{matrix}
\right]=FP_1=F
\left[
\begin{matrix}
u_1\\
v_1\\
1
\end{matrix}
\right]
$`</center>

其中X、Y、Z表示直线向量，F表示基本矩阵。然后确定匹配点到对应极线的距离为:<center>`$D=\frac{|P_2^TFP_1|}{\sqrt{\|X\|^2+\|Y\|^2}}$`</center>
    
    此处为点到直线距离公式
    
其中D代表距离。检测运动一致性和确定动态点的算法如算法1所示，其中`$\varepsilon$`为预设阈值。
***
>算法1：动态点检测算法  
输入：上一帧`$F_1$`,上一帧的特征点`$P_1$`,当前帧`$F_2$`;  
输出：动态点集合`$S$`  
步骤：  
1 当前帧特征点`$P_2=CalcOptical FlowPyrLK(F_1,F_2,P_2)$`
(光流跟踪)  
2 移除`$P_2$`中的外点  
3 `$FM=FindFundamentalMatrix(P_1,P_2)$`(计算基础矩阵)  
4 遍历对每对匹配上的特征点`$p_1,p_2$`in`$P_1,P_2$`  
`$I_1=FindEpipolarLine(p_1,F_M)$`(计算极线)  
`$D=CalcDistanceFromEpipolarLine(p_2,I_1)$`(计算匹配点到对应极线的距离)  
`$if  D>\varepsilon then append p_2 to S end if$`(判断距离是否大于阈值)  
结束循环
***
### D.外点剔除
由于人体等运动物体的柔性变形和复杂运动，运动一致性检测方法很难提取出完整的动态区域的轮廓，提取整个轮廓的时间成本非常昂贵。在DS-SLAM。由于采用了语义分割网络，可以很容易地得到目标的完整轮廓。我们的思想是将语义信息和移动一致性检查结果结合起来，完成两层语义知识库的建立:对象是否移动。如果运动一致性检查产生一定数量的动态点落在被分割对象的轮廓上，则确定该对象正在运动。如果被分割的对象被确定为移动的，则删除位于该对象轮廓上的所有特征点。这样，就可以精确地消除异常值。此外，错误分割的影响也可以在一定程度上降低。    

此外，可以充分利用跟踪线程等待另一个线程的语义分割结果的时间。在等待期间，可以执行移动一致性检查。在下一个实验结果部分。表4给出了DS-SLAM中的消耗时间。可以看出，跟踪线程所用的时间与语义分割线程的时间大致相等。  
  
由于在大多数实际应用场景中，人类活动对机器人定位的干扰非常严重，而语义分割网络能够识别的类别有限，因此在本文的其余部分中，我们将人类作为动态对象的典型代表。理论上，DS-SLAM适用于任何多个可识别和分割的动态对象。  
  
在语义分割结果出来后，如果没有检测到人，那么所有的ORB特征都会直接与最后一帧匹配来预测姿态。否则，使用移动一致性检查结果确定人员是否在移动。如果人们决定保持静止，那么直接预测姿势。否则，在匹配之前，删除所有位于人员轮廓内的ORB特征点。这样可以显著降低动态对象的影响。  
### E.稠密语义3D八叉树地图构建
语义八叉树映射线程从跟踪线程中获取新的关键帧，从语义分割线程中获取分割结果。利用关键帧变换矩阵和深度图像生成局部点云。然后本地点云将在全局八叉树地图中进行转换和维护。我们采用八叉树表示[8]，因为它具有灵活性、紧凑性和可更新性。八叉树映射存储效率高，便于导航。  
  
语义信息也被合并到八叉树地图中。八叉树映射中的每个体素都与特定的颜色相关联，每种颜色表示一个语义标签。例如，红色的体素表示它属于一个沙发，而粉色的体素表示它属于一个人。所有的建模和语义融合过程都是按照概率的方式进行的，因此可以方便地更新体素的属性。这样，密集的语义三维八叉树映射可以为移动机器人完成高级任务提供基础。
  
DS-SLAM是面向动态环境的，所以动态对象不应该存在于地图中。语义分割结果可以有效地滤除动态对象。然而，语义分割的准确性是有限的。在复杂的情况下，例如，对象相互重叠，语义分割结果可能是不完整的，甚至是错误的。为了解决这个问题，在DS-SLAM中使用了log-odds score方法[8] 来最小化动态对象的影响。 log-odds score用于表示单个体素被定量占用的可能性。设`$p\in[0,1]$`表示一个体素被占据的概率，`$l\in R$`表示该概率的log odds score。`$l$`可以通过logit变换计算:<center>`$l=logit(p)=log(\frac{p}{1-p})$`</center>
逆变换为<center>`$p=logit^{-1}(l)=\frac{exp(l)}{exp(l)+1}$`</center>

设`$Z_t$`为体素n在第1时刻的观测结果，其从开始到第t时刻的log odds score为`$L(n|Z_{1:t})$`，则在第t+1时刻，体素n的log odds score可以计算为:<center>`$L(n|z_{1:t+1})=L(n|z_{1:t-1})+L(n|z_t)$`</center>  


当体素n在t时刻被占据时，L = e，否则为0。增量e是一个预定义的值。这个公式表示，当重复观察到体素被占用时，体素的log odds score会增加，否则会减少。一个体素的占据概率p可以通过logit逆变换来计算。只有当占据概率p大于一个预先定义的阈值时，体素才被认为是被占据的，并在八叉树图中被可视化。换句话说，被观察到多次被占据的体素被认为是稳定的被占据体素。该方法能较好地处理动态环境下的地图生成问题。