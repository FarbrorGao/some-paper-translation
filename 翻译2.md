## B.概率剔除外点 
SLAM的一个核心思想是，通过对每一个重新观测到的地图点的三维位置进行更新，对每一个新的测量值对三维世界的地图进行细化。由于某些度量比其他度量更可靠，因此依靠一种利用度量的方差作为权重的概率方法，可能比天真地求平均值做得更好。 

在动态环境中，仅估计地图点的位置是不够的。如果我们使用场景中的所有点执行BA优化，包括动态点，这将导致损坏的优化估计，因为BA优化假定点位置的时间一致性。因此，我们也想知道哪些点对BA优化是足够可靠的。

我们估计了每个地图点的**离群比(inlier ratio)$\phi$**，描述了地图点可靠的稳定点的可能性。inlier比值（离群比）可以用多种方法建模，例如，**一些方法保持跟踪成功和不成功的三角剖分[1]的数量。在[19]中**，**采用概率模型[4]对深度进行联合建模，inlier ratio作为潜在变量**。在这两种情况下，离群比都是通过观察地图点的位置随时间变化来更新的，并根据估计的相机姿态来判断它们是否是动态的。

在单目SLAM中，通过对地图点的运动估计来确定其离群比是很困难的。在缓慢移动的物体的情况下，或者如果一个大的动态物体占据了相机的大部分视角，那么obiect本身就被认为是静态世界的一部分。我们**将语义信息包含在离群比的估计中**，以提供关于地图点是动态的可能性的另一个独立信息源。因此,在深度$d$和窗比$\phi$之外,我们也估计每个地图的语义类$c$。

当观察到一个地图点时，我们用三角剖分法计算其当前深度估计值$d_i$，再加上估计的方差$\tau_i^2$。三角剖分法得到的新测量结果的方差，假设关键点在图像中的位置只有用像素精度[19]才能知道。我们还估计匹配精度$alpha_i\in[0,1]$，如后面所述，并从神经网络中检索关键点的语义类概率$CNN(c_k|I_i)\in[0,1]$。这里$CNN(c_k|I_i)$是网络的输出，可以理解为给定当前图像帧$I_i$中，一个关键点属于语义类$C_k$的概率。

我们定义深度测量的似然概率如式6所示。它是基于[19]的，但我们扩展了它的匹配精度。为了简化符号，我们使用$x^-=(1-x).$
$$p(d_i|d,\phi):=\alpha_i[\phi N(d_i|d,\tau_i^2)+\phi^0 U(d_i)]+\alpha_i^-U(d_i) \tag{6}$$
这个定义背后的直觉是这样的:如果当前键值匹配正确且映射点是静态的。然后两者的匹配精度$\alpha$;离群比$\phi$接近1。因此，假设深度测量$d$;分布为高斯分布$N(\mu,\sigma^2))$，分布在均值$mu$附近，方差$\sigma^2$。另一方面。如果当前匹配错误，或者测点是动态的，则假设当前深度测量是均匀分布$U(a, b)$且对于平均深度d的估计没有提供任何有用的信息。  
与深度的情况类似，我们将映射点的语义建模为网络输出$CNN(c_k|I_i)$和错误匹配的关键点的均匀分布的混合:
$$p(c_k|I_i):=\alpha_iCNN(c_k|I_i)+\alpha^-_iU(C_k) \tag{7}$$
这允许有效的在线更新和地图点之间的动态和静态平稳过渡.

最后，我们需要定义离群比(inlier ratio）对语义类的依赖关系。结果表明，如果我们将depen lency模型化为Beta分布，就可以得到有效的在线参数更新，如公式8所示。
$$p(\phi\|c)=\prod_{k=1}^K(\frac{1}{B(A_k,B_k)}\phi^{A_k-1}(1-\phi)^{B_k-1})^{c_k}$$
![Snipaste_2019-04-19_10-36-39.png](https://i.loli.net/2019/04/19/5cb93449c3356.png)
图3:提出的联合概率模型图。显示深度测量$d_i$、匹配精度$\alpha_i$和离群比$\phi$之间的关系，离群比$\phi$取决于CNN从当前帧预测的语义类概率$c$。
这里的参数$c$是一个热编码的语义类和$A_k,B_k>0$是固定常数，为每个语义类设置。它们表示某个类是静态或动态的可能性(例如，car类有一个低$A_k$和高$B_k$，因为它更有可能是动态的)。相对于深度测量，常量$A_k,B_k$可以被缩放，从而对语义测量施加或多或少的权重，即相对于运动先验，较高的$A_k$和$B_k$更倾向于语义先验.
图3给出了联合模型对深度、离群比和语义类的依赖关系图。测量深度$d_i$依赖于实际深度$d$，匹配精度$\alpha_i$和离群比$\phi$，离群比$\phi$依赖于语义$c$。
近似推理导致后验概率结合了三项。第一项包括深度为高斯分布，第二项是基于深度测量的偏最小二乘分布形式的偏最小二乘分布，第三项是对偏最小二乘与语义类的依赖关系进行建模的偏最小二乘分布。
$$p(d,\phi|D,S)=N(d|\mu,\sigma^2)Beta(\phi,a_{obs},b_{obs})Beta(\phi,a_sem,b_sem) \tag{9}$$
这里$D=\{d_1,...,d_N\}$均为深度测量值，$S={s_1,...,s_N}$均为具有语义信息的观测值，$s_i=(CNN(c_1|I_i),...,CNN(c_K|I_i))$为CNN的输出即为K类的概率密度。

可以看出，所有深度测量值都可以用平均深度$\mu$和深度方差$\sigma^2$来概括，相似的，离群率inlier ratio呈beta分布，参数为$a_obs + a_sem$和$b_obs +b_sem$。通过进一步的代数处理，可以得到这些参数的有效在线更新,支持快速更新点的概率模型。

对于没有语义信息的帧，不使用最后一个术语。$a_sem$和$b_sem$的语义beta分布参数表示为:
$$a_{sem}=\sum_{k=1}^KA_kp(c_k|S)\tag{10}$$
$$b_{sem}=\sum_{k=1}^KB_kp(c_k|S)\tag{11}$$
类后验概率$p(c_k|S)$是所有语义测量值的概率融合，见式12。与已有的融合方法[13]相比，式7中的定义根据每个测量$\alpha_i$的匹配精度，导致加权语义融合.
$$p(c_k|S)∝\prod_{i=1}^Ncnn(c_k|I_i)^{\alpha_i}\tag{12}$$
为估计描述性特征的匹配精度，用汉明距离来比较二元描述符。
$$\alpha^{descriptive}:=1-min(1,\frac{d(f_i,f_j)}{d_{max}})\tag{13}$$
对于直接特征，我们使用两个归一化图像块之间的光度差。
$$\alpha^{direct}:=1-min(1,\frac{\Delta \Phi(x_i,x_j)}{\Delta\Phi_{max}}) \tag{14}$$
在我们的实现中，我们使用反向深度[4]，[20]，来对无穷远处的点进行建模。[20]还表明，反演深度更有可能是高斯分布的。这取决于我们是否使用地图点进行姿态估计(主动)或不主动(非主动)。目前的离群比可计算如式15所示。
$$\phi=\frac{a_{obs}+a_{sem}}{a_{obs}+a_{sem}+b_{obs}+b_{sem}}$$
## C.实时语义分割
在高度动态的场景中，图像内容可以快速变化。对于快速移动的相机，我们需要在每一帧中提取新的关键点，以保持足够的活动关键点来进行可靠的跟踪。因此，我们在每个新帧中提取关键点，而不仅仅是在关键帧中。为了得到每个新地图点的一致语义度量，我们在所有新帧上运行语义分割。
我们使用了19类预先训练的[8]模型用于CityScapes数据库。我们按照建议的训练过程将模型细化到其他数据集，使最后一层适应于可用的类集。由于缺少其他类的额外信息(这些信息很容易识别)，仅使用静态和动态类而不是多类标签来训练模型会导致稍微糟糕的结果。